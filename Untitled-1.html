export default {
  async fetch(request, env) {
    // ★追加：許可するオリジンのリスト
    const allowedOrigins = [
      'http://localhost:8080',
      'http://localhost:3000',
      'http://localhost:5500',  // ★Live Server デフォルトポート
      'http://127.0.0.1:8080',
      'http://127.0.0.1:3000',
      'http://127.0.0.1:5500',  // ★Live Server 127.0.0.1 版
      // ★GitHub Pages のオリジンを追加（手動で書き換えてください）
      'https://rock2999m.github.io'
    ];
    
    const getOrigin = (req) => req.headers.get('origin') || '';
    const requestOrigin = getOrigin(request);
    const isOriginAllowed = allowedOrigins.includes(requestOrigin);
    
    // ★追加：CORS ヘッダーを取得する関数
    const getCorsHeaders = () => ({
      "Access-Control-Allow-Origin": isOriginAllowed ? requestOrigin : "",
      "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type, X-Auth-Token",
      "Access-Control-Max-Age": "86400"
    });

    // CORS プリフライトリクエストに対応
    if (request.method === "OPTIONS") {
      return new Response(null, {
        status: 204,
        headers: getCorsHeaders()
      });
    }

    const url = new URL(request.url);
    const path = url.pathname;
    const queryParams = url.searchParams;

    // 認証トークンを検証する関数
    const validateAuth = () => {
      const authToken = request.headers.get('X-Auth-Token');
      const envToken = env.WORKERS_AUTH_TOKEN;
      // ★削除：トークンをログ出力しない（急鰨を保護）
      return authToken === envToken;
    };

    try {
      // ============ /api/upload エンドポイント ============
      if (path === '/api/upload') {
        if (!validateAuth()) {
          return new Response(JSON.stringify({ error: 'Unauthorized' }), {
            status: 401,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        const payload = await request.json();
        const endpoint = env.UPLOAD_ENDPOINT;

        const gasRes = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const gasText = await gasRes.text();
        return new Response(gasText, {
          status: gasRes.status,
          headers: {
            'Content-Type': 'application/json',
            ...getCorsHeaders()
          }
        });
      }

      // ============ /api/setSpreadsheetId エンドポイント ============
      if (path === '/api/setSpreadsheetId') {
        if (!validateAuth()) {
          return new Response(JSON.stringify({ error: 'Unauthorized' }), {
            status: 401,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        const payload = await request.json();
        const { spreadsheetId } = payload;

        if (!spreadsheetId) {
          return new Response(JSON.stringify({ error: 'spreadsheetId is required' }), {
            status: 400,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        const endpoint = env.UPLOAD_ENDPOINT;
        if (!endpoint) {
          return new Response(JSON.stringify({ error: 'UPLOAD_ENDPOINT not configured' }), {
            status: 500,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        try {
          // GAS の setTripsSpreadsheetId アクションを呼び出し
          const gasUrl = `${endpoint}?action=setTripsSpreadsheetId&spreadsheetId=${encodeURIComponent(spreadsheetId)}`;
          const gasRes = await fetch(gasUrl, {
            method: 'GET'
          });

          const gasText = await gasRes.text();
          
          // GAS からの応答をパース
          let gasData = {};
          try {
            gasData = JSON.parse(gasText);
          } catch (e) {
            console.error('[Worker] GAS response parse error:', gasText);
            gasData = { error: 'Invalid JSON from GAS', raw: gasText };
          }
          
          return new Response(JSON.stringify(gasData), {
            status: gasRes.status,
            headers: {
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        } catch (error) {
          return new Response(JSON.stringify({ 
            error: 'Set spreadsheet ID failed',
            detail: error.message 
          }), {
            status: 500,
            headers: {
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }
      }

      // ============ /api/get-worker-urls (Worker URL 取得用) ============
      if (path === '/api/get-worker-urls') {
        
        // ★認証チェック：トークン検証が必須
        if (!validateAuth()) {
          return new Response(JSON.stringify({ error: 'Unauthorized' }), {
            status: 401,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }
        
        return new Response(JSON.stringify({
          WEATHER_WORKER_URL: env.WEATHER_WORKER_URL || '',
          TIDE_WORKER_URL: env.TIDE_WORKER_URL || '',
          EXIF_WORKER_URL: env.EXIF_WORKER_URL || '',
          WATER_WORKER_URL: env.WATER_WORKER_URL || '',
          WORKERS_AUTH_TOKEN: env.WORKERS_AUTH_TOKEN || '',
          timestamp: new Date().toISOString()
        }), {
          status: 200,
          headers: { 
            'Content-Type': 'application/json',
            ...getCorsHeaders()
          }
        });
      }

      // ============ /api/weather エンドポイント ============
      if (path === '/api/weather') {
        if (!validateAuth()) {
          return new Response(JSON.stringify({ 
            error: 'Unauthorized'
            // ★削除：デバッグ情報を露出しない
          }), {
            status: 401,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        const body = await request.json();

        // ★修正：環境変数から Worker URL を読み込む
        const weatherWorkerUrl = env.WEATHER_WORKER_URL || 'https://noisy-grass-c7e9.yuji-fallline2999m.workers.dev';
        
        try {
          const weatherRes = await fetch(weatherWorkerUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          });

          const weatherData = await weatherRes.json();
          
          return new Response(JSON.stringify(weatherData), {
            status: weatherRes.status,
            headers: {
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        } catch (error) {
          return new Response(JSON.stringify({ 
            error: 'Weather fetch failed',
            detail: error.message 
          }), {
            status: 500,
            headers: {
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }
      }

      // ============ /api/tide エンドポイント ============
      if (path === '/api/tide') {
        if (!validateAuth()) {
          return new Response(JSON.stringify({ error: 'Unauthorized' }), {
            status: 401,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        const body = await request.json();

        // ★修正：環境変数から Worker URL を読み込む
        const tideWorkerUrl = env.TIDE_WORKER_URL || 'https://jolly-voice-b254.yuji-fallline2999m.workers.dev';
        
        try {
          const tideRes = await fetch(tideWorkerUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          });

          const tideData = await tideRes.json();
          
          return new Response(JSON.stringify(tideData), {
            status: tideRes.status,
            headers: {
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        } catch (error) {
          return new Response(JSON.stringify({ 
            error: 'Tide fetch failed',
            detail: error.message 
          }), {
            status: 500,
            headers: {
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }
      }

      // ============ /api/exif エンドポイント ============
      if (path === '/api/exif') {
        if (!validateAuth()) {
          return new Response(JSON.stringify({ error: 'Unauthorized' }), {
            status: 401,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        const body = await request.json();
        const imageUrl = body.imageUrl;
        const rapidApiKey = env.RAPIDAPI_KEY;

        if (!rapidApiKey) {
          return new Response(JSON.stringify({ error: 'RAPIDAPI_KEY not configured' }), {
            status: 500,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        if (!imageUrl) {
          return new Response(JSON.stringify({ error: 'imageUrl is required' }), {
            status: 400,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        // ★修正：環境変数から Worker URL を読み込む
        const exifWorkerUrl = env.EXIF_WORKER_URL || 'https://rough-math-5fec.yuji-fallline2999m.workers.dev';
        
        try {
          const exifRes = await fetch(exifWorkerUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ imageUrl })
          });

          const exifData = await exifRes.json();
          
          return new Response(JSON.stringify(exifData), {
            status: exifRes.status,
            headers: {
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        } catch (error) {
          return new Response(JSON.stringify({ 
            error: 'EXIF fetch failed',
            detail: error.message 
          }), {
            status: 500,
            headers: {
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }
      }

      // ============ /api/getSheetConfig エンドポイント ============
      if (path === '/api/getSheetConfig') {
        if (!validateAuth()) {
          return new Response(JSON.stringify({ error: 'Unauthorized' }), {
            status: 401,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        const endpoint = env.UPLOAD_ENDPOINT;
        if (!endpoint) {
          return new Response(JSON.stringify({ error: 'UPLOAD_ENDPOINT not configured' }), {
            status: 500,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        try {
          // ★修正：GAS の getSheetConfig アクションを GET/POST 両対応で呼び出し
          let gasUrl;
          let gasOptions = {};
          
          if (request.method === 'GET') {
            // GET リクエストの場合：クエリパラメータで action を指定
            gasUrl = `${endpoint}?action=getSheetConfig&_=${Date.now()}`;
            gasOptions = { method: 'GET' };
          } else {
            // POST リクエストの場合：GET に統一（GAS は POST に対応していないため）
            gasUrl = `${endpoint}?action=getSheetConfig&_=${Date.now()}`;
            gasOptions = { method: 'GET' };
          }
          
          const gasRes = await fetch(gasUrl, gasOptions);

          const gasText = await gasRes.text();
          
          // GAS からの応答をパース
          let gasData = {};
          try {
            gasData = JSON.parse(gasText);
          } catch (e) {
            console.error('[Worker] GAS response parse error:', gasText);
            gasData = { error: 'Invalid JSON from GAS', raw: gasText };
          }
          
          return new Response(JSON.stringify(gasData), {
            status: gasRes.status,
            headers: {
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        } catch (error) {
          return new Response(JSON.stringify({ 
            error: 'Sheet config fetch failed',
            detail: error.message 
          }), {
            status: 500,
            headers: {
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }
      }

      // ============ /api/getSheetData エンドポイント ============
      if (path === '/api/getSheetData') {
        if (!validateAuth()) {
          return new Response(JSON.stringify({ error: 'Unauthorized' }), {
            status: 401,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        // ★修正：GET/POST 両対応
        let sheetId, sheetName;
        
        if (request.method === 'GET') {
          // GET リクエストの場合：クエリパラメータから取得
          sheetId = queryParams.get('sheetId');
          sheetName = queryParams.get('sheetName');
        } else {
          // POST リクエストの場合：JSON ボディから取得
          const payload = await request.json();
          sheetId = payload.sheetId;
          sheetName = payload.sheetName;
        }

        if (!sheetId || !sheetName) {
          return new Response(JSON.stringify({ error: 'sheetId and sheetName are required' }), {
            status: 400,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        const endpoint = env.UPLOAD_ENDPOINT;
        if (!endpoint) {
          return new Response(JSON.stringify({ error: 'UPLOAD_ENDPOINT not configured' }), {
            status: 500,
            headers: { 
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }

        try {
          // ★修正：GAS の getSheetData アクションを GET/POST 両対応で呼び出し
          let gasUrl;
          let gasOptions = {};
          
          if (request.method === 'GET') {
            // GET リクエストの場合：クエリパラメータで指定
            gasUrl = `${endpoint}?action=getSheetData&sheetId=${encodeURIComponent(sheetId)}&sheetName=${encodeURIComponent(sheetName)}&_=${Date.now()}`;
            gasOptions = { method: 'GET' };
          } else {
            // POST リクエストの場合：GET に統一（GAS は doGet で実装されているため）
            gasUrl = `${endpoint}?action=getSheetData&sheetId=${encodeURIComponent(sheetId)}&sheetName=${encodeURIComponent(sheetName)}&_=${Date.now()}`;
            gasOptions = { method: 'GET' };
          }
          
          const gasRes = await fetch(gasUrl, gasOptions);

          const gasText = await gasRes.text();
          
          // GAS からの応答をパース
          let gasData = {};
          try {
            gasData = JSON.parse(gasText);
          } catch (e) {
            console.error('[Worker] GAS response parse error:', gasText);
            gasData = { error: 'Invalid JSON from GAS', raw: gasText };
          }
          
          return new Response(JSON.stringify(gasData), {
            status: gasRes.status,
            headers: {
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        } catch (error) {
          return new Response(JSON.stringify({ 
            error: 'Sheet data fetch failed',
            detail: error.message 
          }), {
            status: 500,
            headers: {
              'Content-Type': 'application/json',
              ...getCorsHeaders()
            }
          });
        }
      }

    } catch (error) {
      // ★削除：本番環境では粗いエラーメッセージのみ（スタックトレースを揭示しない）
      return new Response(JSON.stringify({ 
        error: 'Internal Server Error'
      }), {
        status: 500,
        headers: { 
          'Content-Type': 'application/json',
          ...getCorsHeaders()
        }
      });
    }
  }
};
